[缩略图](https://zh.wikipedia.org/wiki/File:Kernel_Layout.svg "fig:缩略图")是应用程序与计算机硬件交互的桥梁。\]\]
**内核补丁保护**（） ，俗名PatchGuard，是[Microsoft
Windows](https://zh.wikipedia.org/wiki/Microsoft_Windows "wikilink")
64位（[x64](../Page/X86-64.md "wikilink")）版本中预防对[内核进行修补的一种特性](../Page/内核.md "wikilink")。该特性2005年在[Windows
XP与](../Page/Windows_XP_Professional_x64_Edition.md "wikilink")[Windows
Server 2003](../Page/Windows_Server_2003.md "wikilink") Service Pack
1的64位版本中首次推出。\[1\]

“修补内核”是指对Windows操作系统的核心组件或内核进行本不支持的修改。这种修改没有得到微软的支持，并据微软称可能大幅降低系统的安全性、可靠性以及性能。尽管微软并不推荐，但在Windows的x86版本上修补内核没有受到限制；而在Windows的x64版本中，微软选择为此行为实施额外的保护和技术障碍。

因为32位（x86）版本的Windows可以随意修补内核，所以有众多[反病毒软件开发人员使用此技术来实现反病毒等安全功能](../Page/杀毒软件.md "wikilink")。在不再支持此技术的x64版本Windows上，防病毒厂商不得不重新设计其软件以另寻他法。

不过，由于Windows内核的设计，内核补丁保护并不能完全阻拦内核修补。因而这引发了对内核补丁保护的批评，指责它是一种不完美的防护措施，对反病毒厂商造成的障碍超过了其带来的好处，因为恶意软件的作者可能找到方案来绕过该措施。尽管如此，内核补丁保护仍可防止由合法软件以不受支持方式进行的内核修补，这可能对系统的稳定性、可靠性和性能带来负面结果。

## 技术概述

[Windows内核在设计上使](../Page/Windows_NT体系结构.md "wikilink")[设备驱动程序有与操作系统内核相同的特权级别](../Page/驱动程序.md "wikilink")。\[2\]预期的设备驱动程序不会修改或修补内核中的核心系统结构。但在Windows的[x86版本中](https://zh.wikipedia.org/wiki/x86 "wikilink")，Windows没有强制要求此预期。因而，部分x86软件（尤其是某些安全和反病毒软件）在设计上采用加载驱动程序来修改核心内存结构的工作方式。\[3\]

在Windows的[x64版本中](../Page/X86-64.md "wikilink")，微软开始以内核驱动保护技术限制驱动程序可以修改与不能修改的结构。该技术定期检查内核中受保护的系统结构以验证其未被修改。如果检测到修改，Windows将触发一个并以[蓝屏死机关闭系统](../Page/蓝屏死机.md "wikilink")（并可能重启）\[4\]。所触发的错误检查编码为0x109，名称CRITICAL_STRUCTURE_CORRUPTION。被禁止的修改包括：

  - 對進行修改或鉤子(Hook)
  - 修改[系统调用表](https://zh.wikipedia.org/wiki/系统调用 "wikilink")
  - 修改
  - 修改
  - 使用未由内核分配的内核[堆栈](../Page/堆栈.md "wikilink")
  - 修改或修补内核本身、[硬體抽象層](../Page/硬體抽象層.md "wikilink")（HAL）或[網絡驅動程式介面規範](https://zh.wikipedia.org/wiki/網絡驅動程式介面規範 "wikilink")（NDIS）内核库中包含的代码\[5\]

内核补丁保护只防御设备驱动程序对内核进行的修改，而不会干涉对另一个驱动程序的修补。\[6\]

还有一点，由于设备驱动程序有与内核本身相同的特权级别，因此不可能充分防止驱动程序绕过内核补丁保护并修补内核。\[7\]不过，内核补丁保护的确对内核修补构成了重大阻碍。随着高度[混淆的代码和令人含混的符号名称](../Page/代码混淆.md "wikilink")，内核补丁保护默默地以此抵御了绕过该技术的企图。\[8\]对该技术本身的定期更新也使对其绕过更加困难，已有绕过技术可能随着更新而失效。自2005年创建以来，微软已经发布过对该技术的两个主要更新，每个更新都是为解决已知的针对此前版本的旁路技术。\[9\]\[10\]

## 优点

因为可能导致许多负面影响，内核修补从未得到微软官方的支持。内核补丁保护可以预防下列影响：

  - 内核中的严重错误。\[11\]
  - 多个程序尝试修补内核的相同部分导致的可靠性问题。\[12\]
  - 受损的系统安全性。
  - [Rootkit可使用内核访问将其嵌入到操作系统](../Page/Rootkit.md "wikilink")，使其近乎不可能被删除。

微软在此技术的常见问题解答（FAQ）中进一步阐述：

## 缺点

### 第三方软件

部分计算机安全软件（如[迈克菲的](../Page/迈克菲.md "wikilink")和[赛门铁克的](../Page/赛门铁克.md "wikilink")[諾頓防毒](../Page/諾頓防毒.md "wikilink")）在x86系统上通过修补内核来工作。[卡巴斯基實驗室制作的反病毒软件也已知广泛使用内核代码修补程序](../Page/卡巴斯基實驗室.md "wikilink")。\[13\]这些程序由于内核补丁保护的存在而无法在Windows
64位版本上正常运行。\[14\]就此情况，McAfee曾呼吁微软完全删除Windows中的内核补丁保护，或者对“可信公司”制作的软件进行例外处理。\[15\]

赛门铁克的企业防病毒软件\[16\]和Norton 2010左右\[17\]在有内核补丁保护的Windows
x64版本上能正常工作，但对零日恶意软件的防护能力有所降低。[ESET](../Page/ESET.md "wikilink")\[18\]、[Trend
Micro](../Page/趨勢科技.md "wikilink")\[19\]、
AVG\[20\]、[avast\!](https://zh.wikipedia.org/wiki/avast! "wikilink")、[Avira](https://zh.wikipedia.org/wiki/Avira "wikilink")
Anti-Vir和等公司制作的反病毒软件在默认配置下不修补内核，但当启用如“高级进程保护”、“阻止未经授权的进程终止”等功能时可能会修补内核。\[21\]

[Jim_Allchin_at_PDC_2005.jpeg](https://zh.wikipedia.org/wiki/File:Jim_Allchin_at_PDC_2005.jpeg "fig:Jim_Allchin_at_PDC_2005.jpeg")

微软不曾添加例外来削弱“内核补丁保护”的影响范围，不过有不时放宽其限制，例如为了[Hypervisor虚拟化软件的正常运行](../Page/Hypervisor.md "wikilink")。\[22\]\[23\]另外，微软与第三方公司合作，新增了[应用程序接口来帮助安全软件执行所需任务](../Page/应用程序接口.md "wikilink")，以免除修补内核的需要。\[24\]新接口在[Windows
Vista Service Pack 1中被引入](../Page/Windows_Vista.md "wikilink")。\[25\]

### 弱点

由于Windows内核的设计，内核补丁保护并不能完全阻止对内核的补丁。\[26\]这导致安全软件提供商[迈克菲和](../Page/迈克菲.md "wikilink")[赛门铁克称内核补丁保护是一个不完美的防御](../Page/赛门铁克.md "wikilink")，给安全软件厂商带来的问题超过了其益处，因为[恶意软件可以比较容易的找出内核补丁保护的绕过方法](../Page/恶意软件.md "wikilink")，而第三方安全软件必须在其限制下设计和运作。\[27\]\[28\]

2006年1月，[化名](../Page/化名.md "wikilink")“skape”和“Skywing”的安全研究员发布的一份报告介绍了一些理论上可以绕过内核补丁保护的方法。\[29\]Skywing于2007年1月继续发布了有关绕过“内核补丁保护”第2版的第二份报告\[30\]，并于2007年9月发布有关“内核补丁保护”第3版的第三份报告。\[31\]2006年10月，安全公司也开发了一种可绕过该技术的有效方法。\[32\]

\[33\]

虽说如此，微软表示作为安全响应中心标准流程的一部分，在致力于消除任何使内核补丁保护被绕过的缺陷。\[34\]微软已发布过对该技术的两次主要更新，每次都是为解决已知的针对此前版本的绕过技术。\[35\]\[36\]\[37\]

### 反垄断行为

2006年，[欧盟委员会对内核补丁保护表示担忧](https://zh.wikipedia.org/wiki/欧盟委员会 "wikilink")，称它是反竞争举措。\[38\]不过，微软自己的反病毒产品[Windows
Live
OneCare没有在内核补丁保护上有特别例外](../Page/Windows_Live_OneCare.md "wikilink")，而是始终在使用其他方法提供病毒防护服务。\[39\]但由于其他原因，Windows
Live OneCare的x64版本在2007年11月15日之前不可用。\[40\]

## 参考资料

## 外部链接

  - [The Truth About PatchGuard: Why Symantec Keeps
    Complaining](https://web.archive.org/web/20070217053224/http://www.windows-now.com/blogs/robert/archive/2006/08/12/PatchGuard-and-Symantecs-Complaints-About-Windows-Vista.aspx)
  - [An Introduction to Kernel Patch
    Protection](https://web.archive.org/web/20061124094344/http://blogs.msdn.com/windowsvistasecurity/archive/2006/08/11/695993.aspx)
  - [Microsoft executive clarifies recent market confusion about Windows
    Vista
    Security](https://web.archive.org/web/20070205155710/http://www.microsoft.com/security/windowsvista/allchin.mspx)
  - [Kernel Patch Protection: Frequently Asked
    Questions](https://web.archive.org/web/20070304110141/http://www.microsoft.com/whdc/driver/kernel/64bitpatch_FAQ.mspx)
  - [Windows Vista x64 Security – Pt 2 –
    Patchguard](https://blogs.technet.com/security/archive/2006/08/12/446104.aspx)

**Uninformed.org文章：**

  - [Bypassing PatchGuard on Windows
    x64](http://www.uninformed.org/?v=3&a=3)
  - [Subverting PatchGuard
    Version 2](http://www.uninformed.org/?v=6&a=1)
  - [PatchGuard Reloaded: A Brief Analysis of PatchGuard
    Version 3](http://www.uninformed.org/?v=8&a=5)

**绕过方法：**

  - [KPP Destroyer (including source code)
    - 2015](http://forum.cheatengine.org/viewtopic.php?t=573311)
  - [A working driver to bypass PatchGuard 3 (including source code)
    - 2008](http://www.codeproject.com/KB/vista-security/bypassing-patchguard.aspx)
  - [Bypassing PatchGuard with a hex editor
    - 2009](http://fyyre.ru/vault/bootloader.txt)

**微软安全通告：**

  - [June 13, 2006 update to Kernel Patch
    Protection](https://web.archive.org/web/20110606104336/http://www.microsoft.com/technet/security/advisory/914784.mspx)
  - [August 14, 2007 update to Kernel Patch
    Protection](https://web.archive.org/web/20110806064637/http://www.microsoft.com/technet/security/advisory/932596.mspx)

[Category:Microsoft_Windows安全技术](https://zh.wikipedia.org/wiki/Category:Microsoft_Windows安全技术 "wikilink")
[Category:Windows_NT](https://zh.wikipedia.org/wiki/Category:Windows_NT "wikilink")

1.

2.

3.   "This has never been supported and has never been endorsed by us.
    It introduces insecurity, instability, and performance issues, and
    every time we change something in the kernel, their product breaks."
    —Ben Fathi, corporate vice president of Microsoft's security
    technology unit

4.

5.

6.

7.

8.

9.

10.

11.

12.

13.

14.

15.

16.

17.

18.

19.

20.

21.

22.
23.

24.
25.

26.
27.
28.  "The system's already vulnerable. People have already hacked into
    PatchGuard. System is already vulnerable no matter what. PatchGuard
    has a chilling effect on innovation. The bad guys are always going
    to innovate. Microsoft should not tie the hands of the security
    industry so they can't innovate. We're concerned about
    out-innovating the bad guys out there." —Cris Paden, Manager on the
    Corporate Communication Team at Symantec

29.

30.

31.

32.

33. [新型“鬼钩”攻击可绕过Windows PatchGuard保护 |
    E安全](https://www.easyaq.com/news/1292647080.shtml)

34.

35.
36.
37.
38.

39.

40.
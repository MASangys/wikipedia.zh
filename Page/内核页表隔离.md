**内核页表隔离**（，缩写KPTI，也简称PTI，旧称KAISER）是[Linux内核中的一种](../Page/Linux内核.md "wikilink")技术，旨在更好地隔离[用户空间与内核空间的](https://zh.wikipedia.org/wiki/用户空间 "wikilink")[内存来提高安全性](../Page/虚拟内存.md "wikilink")，缓解现代[x86](https://zh.wikipedia.org/wiki/x86 "wikilink")
[CPU中的](https://zh.wikipedia.org/wiki/CPU "wikilink")“[熔毁](../Page/熔毁_\(安全漏洞\).md "wikilink")”硬件安全缺陷。\[1\]\[2\]

## 前身

KPTI补丁基于KAISER，它是一个用于缓解不太重要问题的早期补丁，当时业界还未了解到Meltdown的存在。

如果没有KPTI，每当执行用户空间代码（[应用程序](../Page/应用程序.md "wikilink")）时，Linux会在其[分頁表中保留整个内核内存的映射](../Page/分頁表.md "wikilink")，并保护其访问。这样做的优点是当应用程序向内核发送[系统调用或收到](https://zh.wikipedia.org/wiki/系统调用 "wikilink")[中斷时](../Page/中斷.md "wikilink")，内核页表始终存在，可以避免绝大多数[上下文交換相关的开销](../Page/上下文交換.md "wikilink")（[TLB刷新](../Page/轉譯後備緩衝區.md "wikilink")、页表交换等）。

2005年，Linux内核采用了[位址空間配置隨機載入](../Page/位址空間配置隨機載入.md "wikilink")（KASLR）隐匿用户空间中的相关内核地址，增加了利用其他内核[漏洞的难度](https://zh.wikipedia.org/wiki/计算机安全隐患 "wikilink")\[3\]\[4\]。尽管阻止了对这些内核映射的访问，但在此后发现，现有的[英特尔x](../Page/英特尔.md "wikilink")86处理器（截至2017年12月\[5\]）还存在着多处可能泄露这些内存位置的[旁路攻击](../Page/旁路攻击.md "wikilink")，可能绕过KASLR。\[6\]\[7\]\[8\]\[9\][AMD称其处理器不受这些攻击的影响](../Page/超威半导体.md "wikilink")，所以不需要KPTI作为缓解措施。\[10\]\[11\]\[12\]\[13\]\[14\]\[15\]\[16\]

## Meltdown漏洞与KPTI

2018年1月，影响[Intel](https://zh.wikipedia.org/wiki/Intel "wikilink")
x86处理器的[熔毁漏洞被公布](../Page/熔毁_\(安全漏洞\).md "wikilink")。KAISER补丁改为修复此问题，并更名为KPTI，因为新型攻击很类似，尽管更为严重。

## 实现

KPTI通过完全分离用户空间与内核空间页表来解决页表泄露。支持进程上下文标识符（PCID）特性的x86处理器可以用它来避免TLB刷新，但即便如此，它依然有很高的性能成本。据KAISER原作者称，其开销为0.28%\[17\]；一名Linux开发者称大多数工作负载下测得约为5%，但即便有PCID优化，在某些情况下开销高达30%。\[18\]

KPTI在2018年早期被合并到Linux内核4.15版\[19\]\[20\]，并被反向移植到Linux内核4.14.11。[Windows](https://zh.wikipedia.org/wiki/Microsoft_Windows "wikilink")\[21\]和[macOS](https://zh.wikipedia.org/wiki/macOS "wikilink")\[22\]也发布了类似的更新。

使用内核启动选项“pti=off”可以部分禁用内核页表隔离。依规定也可对已修复漏洞的新款处理器禁用内核页表隔离\[23\]。

## 参见

  - [熔毁 (安全漏洞)](../Page/熔毁_\(安全漏洞\).md "wikilink")
  - [幽灵 (安全漏洞)](https://zh.wikipedia.org/wiki/幽灵_\(安全漏洞\) "wikilink")
  - [奔腾浮点除-{}-错误](../Page/奔腾浮点除错误.md "wikilink")

## 参考文献

## 外部链接

  - [英特尔陷芯片安全问题漩涡_新浪网](https://tech.sina.com.cn/zt_d/intel/)
  - [KPTI documentation patch](https://lkml.org/lkml/2017/12/18/1523)

[Category:Linux内核功能](https://zh.wikipedia.org/wiki/Category:Linux内核功能 "wikilink")
[Category:虚拟内存](https://zh.wikipedia.org/wiki/Category:虚拟内存 "wikilink")
[Category:X86架構](https://zh.wikipedia.org/wiki/Category:X86架構 "wikilink")

1.

2.

3.

4.

5.

6.
7.

8.

9.

10.

11.

12.

13.

14.

15.

16.

17.
18.
19.

20.

21.

22.

23.
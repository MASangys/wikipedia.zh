是由部分[編譯器支援的一種功能](../Page/編譯器.md "wikilink")。其將非常低階的[組合語言內嵌在](https://zh.wikipedia.org/wiki/組合語言 "wikilink")[高階語言源始碼中](https://zh.wikipedia.org/wiki/高階語言 "wikilink")。實施行內組語通常是為了以下理由：

  - **執行效率最佳化**：將[演算法中最攸關效能的部份使用手寫組語取代高階程式碼](https://zh.wikipedia.org/wiki/演算法 "wikilink")，優點是不會受到編譯器的限制。
  - **使用處理器特有指令**：某些處理器提供特定的指令，比如Compare-and-swap和Test-and-set指令可以直接用以實作[信號機制](https://zh.wikipedia.org/wiki/信号_\(计算机科学\) "wikilink")。因為[多工系統都需要信號機制](https://zh.wikipedia.org/wiki/多工 "wikilink")，幾乎所有現代的處理器都支援前述的兩個指令。其它的一些指令集如[SPARC架構的](../Page/SPARC.md "wikilink")[VIS指令集](../Page/VIS指令集.md "wikilink")，[Intel處理器的](https://zh.wikipedia.org/wiki/Intel "wikilink")[MMX指令集以及](../Page/MMX.md "wikilink")[SSE指令集等](../Page/SSE.md "wikilink")。
  - **[系統調用](https://zh.wikipedia.org/wiki/系统调用 "wikilink")**（System
    Call）：高階語言鮮少提供直接調用system calls的機制，故使用組語來進行這項工作。

## 使用處理器持有指令優化範例

下面是一段在[D語言進行行內組語的程式碼](../Page/D語言.md "wikilink")。該程式碼使用[x86架構的](../Page/X86.md "wikilink")[浮點運算器指令來計算](https://zh.wikipedia.org/wiki/FPU "wikilink")\(\tan x\)。此實作快於編譯器產生的一系列浮點數運算，行內組語也使編程人員得以使用`fldpi`指令來載入在x86架構下可得到的最佳之[pi估計值](https://zh.wikipedia.org/wiki/pi "wikilink")。

``` d
// 計算tan(x)
real tan(real x)
{
   asm
   {
       fld     x[EBP]                  ; // 將x值載入浮點運算器的堆疊上
       fxam                            ; // 測試堆疊頂端的值是否是合法、可計算浮點數
       fstsw   AX                      ;
       sahf                            ;
       jc      trigerr                 ; // 若x是NAN,正負無限，或空值
                                         // 387可以處理denormals數值
SC18:  fptan                           ; // 為與8087運算器相容fptan會使堆疊頂端為1.0，再來才是tan值，
       fstp    ST(0)                   ; // 丟棄堆疊頂端的值
       fstsw   AX                      ;
       sahf                            ;
       jnp     Lret                    ; // C2為FPU狀態變數，C2 == 1表示x超出允許的範圍
                                       ; // tan之週期為pi，下面的程式碼就是將x縮至允許的範圍
       fldpi                           ;
       fxch                            ;
SC17:  fprem1                          ;
       fstsw   AX                      ;
       sahf                            ;
       jp      SC17                    ;
       fstp    ST(1)                   ; // 將pi值移出堆疊
       jmp     SC18                    ;
   }
trigerr:
   return real.nan;
Lret:
   ;
}
```

## 系統調用（system calls）範例

在[保護模式運行的應用程式無法直接呼叫專屬於](../Page/保護模式.md "wikilink")[OS的功能](https://zh.wikipedia.org/wiki/操作系統 "wikilink")。因為[OS的行程空間包含](https://zh.wikipedia.org/wiki/作業系統 "wikilink")[核心空間](https://zh.wikipedia.org/wiki/核心空間 "wikilink")（kernel
mode）與[用戶空間](https://zh.wikipedia.org/wiki/用戶空間 "wikilink")（user
mode）；運行在用戶空間的程式只能透過[中斷來引用專屬於作業系統的功能](../Page/中斷.md "wikilink")。通常[高階語言都不提供這項功能](https://zh.wikipedia.org/wiki/高階語言 "wikilink")，所以要運用行內組語將呼叫system
calls的過程包裝為高階語言可辨認、呼叫的函式。

下面的C語言片段即含有一個system
call的包裝函式。其組語語法為[GNU汇编器使用的](../Page/GNU汇编器.md "wikilink")[AT\&T組語語法](https://zh.wikipedia.org/wiki/AT&T組語語法 "wikilink")。一般這類程式都會使用[巨集實作](../Page/巨集.md "wikilink")，不過為了清楚展示觀念，在此列出了完整的程式碼。

GNU組譯器的行內組語語法相當直覺，基本型式如下：

``` c
asm("assembly code");
```

例如：

``` c
asm("movl %ecx, %eax"); /* 複製ecx暫存器的內容至eax暫存器*/
```

或

``` c
__asm_("movb %bh, (%eax)"); /* 從bh暫存器複製1位元組的資料到eax暫存器所指的記憶體區塊*/
```

必須注意的是，AT\&T語法中的運算元順序與[Windows平台下常用的](https://zh.wikipedia.org/wiki/Windows "wikilink")[MASM剛好相反](../Page/MASM.md "wikilink")。

`asm`跟`__asm__`都是合法型式；當`asm`與程式碼中某些變數命名起衝突時可使用後者。

``` c
extern int errno;

int funcname（int arg1, int *arg2, int arg3）
{
  int res;
  __asm__ volatile(
    "int $0x80"        /* 向OS拋出請求*/
    : "=a" (res)       /* 請編譯器將結果將儲存於eax ("a")*/
      "+b"(arg1),     /* 請編譯器將arg1存於ebx ("b")*/
      "+c"(arg2),     /* 請編譯器將arg2存於ecx ("c")*/
      "+d"(arg3)      /* 請編譯器將arg3存於edx ("d")*/
    : "a"(128)       /* 該system call的編號放於eax ("a")*/
    : "memory", "cc"); /* 通知編譯器，記憶體與condition code register（決定分支的暫存器）己被更改*/

  /* 若OS回傳負值表示錯誤；則包裝函式要設定errno global variable並回傳 -1 */
  if (-125 <= res && res < 0) {
    errno = -res;
    res = -1;
  }
  return res;
}
```

## 外部链接

  - [GCC-Inline-Assembly-HOWTO](http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html)
  - [GNAT Inline
    Assembler](https://web.archive.org/web/20110514100544/http://gcc.gnu.org/onlinedocs/gnat_ugn_unw/Inline-Assembler.html)
  - [1](http://www.jaist.ac.jp/iscenter-new/mpc/altix/altixdata/opt/intel/vtune/doc/users_guide/mergedProjects/analyzer_ec/mergedProjects/reference_olh/mergedProjects/instructions/instruct32_hh/vc110.htm)

[Category:程序設計語言](https://zh.wikipedia.org/wiki/Category:程序設計語言 "wikilink")
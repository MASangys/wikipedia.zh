[NCQ.svg](https://zh.wikipedia.org/wiki/File:NCQ.svg "fig:NCQ.svg")
**原生指令排序**（，簡稱**NCQ**），原先是改善伺服器硬碟存取控制技術，應用在[SCSI和](../Page/SCSI.md "wikilink")[SATA
1.0/2.0/3.0介面](../Page/SATA.md "wikilink")[硬碟讀寫加速技術](../Page/硬碟.md "wikilink")，其介面開啟磁碟陣列RAID亦能加速。透過硬碟[韌體](../Page/韌體.md "wikilink")、硬碟控制器以及作業系統三者的互相配合，改善硬碟內部磁區的讀取順序，可以提高硬碟效能，亦能夠輕微減輕硬碟損耗的速率。NCQ對用於伺服器上的硬碟的效率提昇尤為明顯。

## 原理

一般[硬碟使用的](../Page/硬碟.md "wikilink")[硬碟格式通常為](../Page/硬碟格式.md "wikilink")[Windows
98核心所使用的](../Page/Windows_98.md "wikilink")[FAT32系列](../Page/FAT32.md "wikilink")，或是[Windows
NT所使用的](../Page/Windows_NT.md "wikilink")[NTFS](../Page/NTFS.md "wikilink")，此種硬碟格式在存取資料時，時常會出現散亂的情況，導致一個文件被不規則的分散成許多的區塊存放於[磁盤上面](../Page/磁盤.md "wikilink")，時間一久，[文件散亂的程度會日趨嚴重](../Page/文件.md "wikilink")，由於傳統的硬碟讀取方式，會從文件的開頭依序讀取到結尾，若文件散亂的程度愈嚴重，則[讀取頭需要來回移動的距離就越長](../Page/讀取頭.md "wikilink")，導致[硬碟讀寫效能逐漸下降](../Page/硬碟.md "wikilink")。一旦發生這樣的問題，解決方案便是使用[磁碟重組軟體來進行](../Page/磁碟重組軟體.md "wikilink")[硬碟重組](../Page/硬碟重組.md "wikilink")，將散亂的文件重新排列為連續的區塊，但由於執行磁碟重組可能會需要搬動大量的磁碟區塊，如果太常執行磁碟重組，除了會提高系統負載，亦將會縮短磁碟機的使用壽命，NCQ即為了解決此種情況而誕生。NCQ的概念原本是應用在[伺服器上常見的](../Page/伺服器.md "wikilink")[SCSI介面上](../Page/SCSI.md "wikilink")，在SCSI的規格中即包含此項技術，只是不叫做NCQ，將此項技術經過些許修改後稱為NCQ，並將其應用在[SATA介面上](../Page/SATA.md "wikilink")，後來的[SAS介面也支持此項技術](../Page/SAS.md "wikilink")。啟用NCQ技術的硬碟，在讀取文件時，會依照文件在硬碟上的分佈，將存取的順序作最有效率的排序，以減少機械臂移動的距離，進而達到省時以及延長硬碟壽命的效果。

## 優勢

於SATA II NCQ協定中，新增3個功能，分別是：

  - Race-free status return mechanism：
      -
        [硬碟在完成任一指令後](../Page/硬碟.md "wikilink")，可以無須再進行[Handshake即可繼續另一個指令](../Page/握手_\(技術\).md "wikilink")，以便讓多個指令快速接序或同時執行。
  - Interrupt aggregation：
      -
        [硬碟由於以](../Page/硬碟.md "wikilink")[NCQ模式執行多個指令](../Page/NCQ.md "wikilink")，所以原本每一個指令完成後必須[中斷](../Page/中斷.md "wikilink")（interrupt）以便讓系統接續處理的模式，轉成可以在多個指令完成後再一次提出（interrupt），故[介面控制器](../Page/介面控制器.md "wikilink")（host
        controller）對於多個指令只須處理一次中斷即可。
  - First party DMA（FPDMA）：
      -
        當[硬碟完成](../Page/硬碟.md "wikilink")[資料讀取後](../Page/資料.md "wikilink")，無須靠host
        controller的[DMA動作取得特定記憶體位置](../Page/DMA.md "wikilink")，而是由硬碟本身建立[DMA](../Page/DMA.md "wikilink")
        setup [FIS](../Page/FIS.md "wikilink")（Frame Information
        Structure）直接對host
        controller送出[記憶體存取通知](../Page/記憶體.md "wikilink")，如此無須[驅動程式的運作](../Page/驅動程式.md "wikilink")，可以有效提升存取效率。

## 條件

開啟NCQ，除硬碟本身必須支持NCQ外，[作業系統](../Page/作業系統.md "wikilink")（OS）與[介面控制器](../Page/介面控制器.md "wikilink")（controller）的支持也是不可或缺的條件。舉例說，在[Microsoft
Windows平台上](../Page/Microsoft_Windows.md "wikilink")，從[Windows
Vista開始才支持NCQ](../Page/Windows_Vista.md "wikilink")，而[Windows
XP若要使用NCQ](../Page/Windows_XP.md "wikilink")，則要額外安裝支持軟件。

## 支持NCQ技術的晶片組

（舊資料） 支持NCQ的硬碟控制器（部分）:

  - [JMicron](../Page/JMicron.md "wikilink")
      - JMB360
      - JMB361
      - JMB362
      - JMB363
      - JMB365
      - JMB366
  - [Silicon Image](../Page/Silicon_Image.md "wikilink")
      - SiI 3124
      - SiI 3132
      - SiI 3531
  - [nVIDIA](../Page/nVIDIA.md "wikilink")
      - nForce 4 Ultra, nForce 4 [SLI](../Page/SLI.md "wikilink")
      - nForce 410
      - nForce 430
      - nForce 550
      - nForce 570 Ultra, nForce 570 SLI
      - nForce 590 SLI
      - nForce 650i Ultra, nForce 650i SLI
      - nForce 680i SLI
      - nForce 780i SLI
  - [Intel](../Page/Intel.md "wikilink")
    [1](http://www.intel.com/support/chipsets/imst/sb/CS-012304.htm)
      - ESB2
      - ICH6M, ICH6R
      - ICH7DH, ICH7M, ICH7MDH, ICH7R
      - ICH8DH, ICH8DO, ICH8M, ICH8M-E, ICH8R
      - ICH9DO, ICH9M, ICH9M-E, ICH9R
      - ICH10D, ICH10DO, ICH10R
      - 5 Series
      - 6 Series
      - 7 Series
      - 3400 Series
  - [VIA](../Page/VIA.md "wikilink")
      - VT 8237S
      - VT 8251
  - [ATI](../Page/ATI.md "wikilink")
      - SB 600
      - SB 700
      - SB 750
  - [ALi](../Page/ALi.md "wikilink")／[ULi](../Page/ULi.md "wikilink")
      - M1573
      - M1575
      - M1567
      - M1697
  - [SiS](../Page/SiS.md "wikilink")
      - SiS966/SiS966L
      - SiS968
  - [Marvell](../Page/Marvell.md "wikilink")
      - 88SE9130

## 參看

  - [TCQ](../Page/TCQ.md "wikilink")（Tagged Command Queuing）
  - [Intel組合儲存技術軟件](../Page/Intel組合儲存技術軟件.md "wikilink")（Intel Matrix
    Storage Manager）

[Category:串行總線](https://zh.wikipedia.org/wiki/Category:串行總線 "wikilink")
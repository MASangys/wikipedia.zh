[Spectre_logo_with_text.svg](https://zh.wikipedia.org/wiki/File:Spectre_logo_with_text.svg "fig:Spectre_logo_with_text.svg") **幽灵**（）是一个存在于[分支预测实现中的](https://zh.wikipedia.org/wiki/分支预测 "wikilink")[硬件缺陷及安全漏洞](https://zh.wikipedia.org/wiki/计算机安全隐患 "wikilink")，含有[预测执行功能的现代](https://zh.wikipedia.org/wiki/预测执行 "wikilink")[微处理器](../Page/微处理器.md "wikilink")均受其影响\[1\]\[2\]，[漏洞利用是基於時間的](https://zh.wikipedia.org/wiki/漏洞利用 "wikilink")[旁路攻擊](https://zh.wikipedia.org/wiki/旁路攻擊 "wikilink")，允许恶意[进程獲得其他程序在](https://zh.wikipedia.org/wiki/进程 "wikilink")[映射内存中的資料内容](../Page/虚拟内存.md "wikilink")。\[3\]\[4\]\[5\]Spectre是一系列的漏洞，基於攻擊行爲類型，賦予了两个[通用漏洞披露ID](https://zh.wikipedia.org/wiki/通用漏洞披露 "wikilink")，分别是（bounds check bypass，边界检查绕过）和（branch target injection，分支目标注入），於2018年1月隨同另一個也基於推測執行機制的、屬於重量級資訊安全漏洞的硬體缺陷「Meltdown」（熔燬）一同公佈。由於該缺陷是推測執行機制導致的，加上不同處理器架構對推測執行又有不同的實作方式，因此這個缺陷無法獲得根源上的修復而只能採取「見招拆招」式的方法防範，而且因機制所致，各種解決方案還有不可預料的效能下降。\[6\]

CVE-2017-5753依赖于運行中的[即时编译](https://zh.wikipedia.org/wiki/即时编译 "wikilink")（JIT）系統，用于[Javascript的JIT引擎已被发现存在此漏洞](https://zh.wikipedia.org/wiki/Javascript "wikilink")。网站可以读取浏览器中存储的另一个网站的数据，或者浏览器本身的内存。對此Firefox 57.0.4（部分）及Chrome 64通过为每个网站分配专用的浏览器进程来阻擋此類攻擊\[7\]\[8\]；作業系統則是通過改寫的編譯器重新編譯以阻擋利用該漏洞進行攻擊的行爲。

針對CVE-2017-5715，除了軟體層面上進行修改以外，處理器也需要通過[微碼更新來阻擋這類攻擊](https://zh.wikipedia.org/wiki/微碼 "wikilink")。\[9\]\[10\]\[11\]

隨著幽靈缺陷衍生的安全漏洞（攻擊手段變體，包括、、等）被逐一發現，英特爾等CPU開發商不得不在修復既有缺陷的同時資助第三方資訊安全團隊繼續發掘潛在的缺陷以破財消災。\[12\]

## 历史

Spectre由[Google](../Page/Google.md "wikilink") [Project Zero的Jann](../Page/Project_Zero_\(Google\).md "wikilink") Horn独立发现，协同 Daniel Genkin、Mike Hamburg、Moritz Lipp和Yuval Yarom也合作发现了此问题。微软漏洞研究（Microsoft Vulnerability Research）则将此问题的波及范围扩展到了浏览器JavaScript的JIT引擎\[13\]\[14\]。2017年6月1日，受影响的硬件供应商知悉此问题。2018年1月3日，此漏洞与另一安全漏洞[熔毁](../Page/熔毁_\(安全漏洞\).md "wikilink")（）被一同公布\[15\]。

## 细节

Spectre是一个可以迫使用户[操作系统](../Page/操作系统.md "wikilink")上的其他程序访问其程序[電腦記憶體](../Page/電腦記憶體.md "wikilink")空间中任意位置的漏洞。

Spectre不是单个易于修复的漏洞，而是\[16\]一类\[17\]潜在漏洞的总和。它们都利用了一种现代[微处理器](../Page/微处理器.md "wikilink")为降低[内存延迟](https://zh.wikipedia.org/wiki/内存延迟 "wikilink")、加快执行速度的常用方法“[预测执行](https://zh.wikipedia.org/wiki/预测执行 "wikilink")”的[副作用](../Page/函数副作用.md "wikilink")。具体而言，Spectre着重于[分支预测](https://zh.wikipedia.org/wiki/分支预测 "wikilink")，这是预测执行的一部分。与同时披露的相关漏洞“熔毁”不同，Spectre不依赖单个处理器上[記憶體管理](../Page/記憶體管理.md "wikilink")及系统保护的特定功能，而是一个更为通用的漏洞。

白皮书的出发点是，对分支预测机制进行边信道定时攻击\[18\]，它是现代微处理器乱序执行的一部分。虽然，处理器的文档保证在[架构级别](../Page/计算机系统结构.md "wikilink")，预测错误所导致的任何后果都会在得到正确结果之后取消，然而预测执行仍然有可能留下副作用，例如已加载的[缓存线](../Page/CPU缓存.md "wikilink")。这些所谓的[非功能性方面随后便可影响计算环境](../Page/非功能性需求.md "wikilink")。如果这种副作用（包括但不限于内存访问时间）对恶意程序可见，并且能设法与受害[行程](../Page/行程.md "wikilink")所保存的敏感数据产生关系，则这些副作用可能会使[敏感数据可被识别](https://zh.wikipedia.org/wiki/信息敏感度 "wikilink")。即使在架构级别，正式的安全设计能正常工作，这种情况仍然会发生；这种情况下，用于代码执行的、[较低级的](https://zh.wikipedia.org/wiki/抽象層 "wikilink")[微架構](../Page/微架構.md "wikilink")优化仍然有可能泄漏对正常程序正确执行不是非常重要的某些信息。

Spectre论文展示了完成攻击的四个基本步骤：

1.  首先，论文阐述了在现代处理器中的，恶意程序可以通过程序内部的运行操纵分支预测逻辑，使得分支预测命中或者失败的情况可以提前判断。
2.  随后展示了，可以可靠地对缓存命中和未命中间的差异进行计时，因此，本来应该是简单的非功能差异，实际却可作为秘密信道，从无关信息中提取进程的内部工作信息。
3.  然后，论文以一个简单的示例程序和一个在[浏览器](../Page/网页浏览器.md "wikilink")[沙盒中运行的](../Page/沙盒_\(電腦安全\).md "wikilink")[JavaScript](../Page/JavaScript.md "wikilink")片段为基础，将结果与[返回导向编程攻击等原理进行综合](https://zh.wikipedia.org/wiki/返回导向编程 "wikilink")；在这两种情况下，只需简单使用由普通编译器或现有浏览器中[JavaScript引擎](../Page/JavaScript引擎.md "wikilink")生成的代码，利用其中条件分支的预测执行，受害者进程的整个地址空间（即运行中程序的内容）都将可读。其基本思想是，在现有的代码中寻找预测执行可能涉及到不可访问数据的地方，操纵处理器，使得预测执行必须触及该数据的实际内容，然后对处理器的副作用计时，这时预取机制已经加载完成了一条缓存线，结果就是访问这条缓存线的数据速度会更快。
4.  最后，本文将这种攻击一般化到受害进程的任何非功能状态上。紧接着讨论了甚至像[总线](https://zh.wikipedia.org/wiki/内存总线 "wikilink")[仲裁](https://zh.wikipedia.org/wiki/仲裁_\(电子\) "wikilink")[延迟这样非常不明显的非功能性效应](../Page/延迟_\(工程学\).md "wikilink")。

Spectre和Meltdown之间的根本区别在于，后者依赖于现代英特尔处理器的特定功能：CPU可能会被诱使预测执行到受保护的系统数据中，被迫进入并处理相关的安全异常。Spectre中的统计学特征更为明显：尽最大努力以某种方式调教处理器的分支预测机制，并使用现有库中可用（或不可用）的代码来实现基本相同的事。

或者换句话说，正如Meltdown论文所说的那样：“Meltdown在几个方面与Spectre攻击有所不同，其中值得注意的是，Spectre需要定制受害者进程的软件环境，但适用的CPU更加广泛，并且[KAISER对其无效](../Page/内核页表隔离.md "wikilink")。”\[19\]

## 影响

截至2018年，几乎所有的计算机系统都受到Spectre的影响，包括台式机、笔记本电脑和移动设备。具体而言，Spectre已证明可以在主要的[Intel](https://zh.wikipedia.org/wiki/Intel "wikilink")、部分[ARM的处理器上工作](https://zh.wikipedia.org/wiki/ARM架構 "wikilink")，特定情況下則在[AMD架構下能運作](https://zh.wikipedia.org/wiki/AMD "wikilink")\[20\]\[21\]。英特尔正式回应了所报告的安全漏洞\[22\]。根据AMD的一份声明，Spectre第二个变种没有发生在AMD处理器上，且由于AMD架构之间存在差异，“风险接近于零”\[23\]。

目前，Spectre只会造成用户级别的程序互相影响，但似乎这种攻击方式可以进一步开发。虽然比[熔毁更难正确使用](../Page/熔毁_\(安全漏洞\).md "wikilink")，但由于它的一般性，Spectre可能会更加难以抵御。原来的白皮书甚至推测，为了完全处理这个问题，可能需要对微处理器体系结构进行重大改变。

而且，对于[云提供商而言](https://zh.wikipedia.org/wiki/云提供商 "wikilink")，Spectre比Meltdown影响更大。Meltdown可使未经授权的应用程序读取特权内存，并获取运行在同一云服务器上进程的敏感数据，而Spectre可让恶意程序诱使[虚拟机管理程序将数据传输到在其上运行的客户系统](https://zh.wikipedia.org/wiki/虚拟机管理程序 "wikilink")\[24\]。

## 防御措施

由于Spectre是一整类的攻击，所以一个补丁很可能无法完全解决。虽然这个漏洞的一些特殊案例已经在处理，但专门介绍“Spectre”和“Meltdown”的网站也说：“Spectre不易修复，所以会长期困扰我们。”\[25\]微软 Windows 系列操作系统于2018年初发布了系统补丁，英特尔公司于事件发生阶段反复表示修复漏洞对性能影响不大，但微软测试表明若安裝Windows 7、Windows 8 操作系统、並使用2015年或更早出厂的英特尔芯片，更新后速度會明显变慢，慢到用户能感受到差异，也有说法是性能约下降30%，尤其是较旧的Haswell架构及之前芯片。但若是安装Windows 10并使用Skylake、Kaby Lake等之后更新版英特尔芯片，则性能下降状况并不明显。\[26\]

尽管如此，已有几个程序帮助保护家庭计算机和相关设备免于“Meltdown”和“Spectre”漏洞的攻击\[27\]\[28\]\[29\]\[30\]。

嵌入在网站中的JavaScript也可用于攻击\[31\]。[Chrome](../Page/Google_Chrome.md "wikilink") 64将默认包含针对此攻击的缓解措施，Chrome 63用户可以通过启用站点隔离功能（chrome://flags\#enable-site-per-process）手动缓解攻击\[32\]。在[Firefox](../Page/Firefox.md "wikilink") 57.0.4中，[Mozilla](../Page/Mozilla.md "wikilink")正在降低JavaScript计时器的精度，以帮助防止计时攻击，同时计划用于将来版本的时间模糊技术也在工作中\[33\]\[34\]。此外，基于浏览器的漏洞利用可以通过禁用JavaScript（例如[NoScript](../Page/NoScript.md "wikilink")）防止。

2018年1月4日，Google在其安全博客上详细介绍了新技术“Retpoline”，该技术能够以微不足道的处理器开销克服Spectre漏洞。它涉及在编译器编译时让间接分支跳转到不同的目标，减少易受攻击的乱序执行发生\[35\]\[36\]。虽然这项技术面向x86指令集开发，Google工程师认为该技术也可以用于其他处理器\[37\]。2019年2月，Google研究人员发表论文认为光靠软件不能完全避开Spectre漏洞，必须对CPU设计进行修改才能避免\[38\]。

也有人提出\[39\]，在有选择性刷新轉譯後備緩衝區（TLB）功能的处理器上，可以减少修补漏洞造成的性能损失。该特性在Intel 64架构下称为进程上下文标识符（PCID），而在Alpha下称为地址空间号码（ASN）。这是因为，选择性刷新可隔离进程，及对漏洞至关重要的[轉譯後備緩衝區](../Page/轉譯後備緩衝區.md "wikilink")（TLB）行为，而不会不断刷新整个TLB，这是性能损失的主要原因。\[40\]

### 微碼、韌體更新

對於幽靈的變體2——分支目標註入，除了軟體的規避阻擋措施外，還至少需要受影響的處理器獲得微碼更新或韌體修復程式。\[41\]受缺陷影響最大的英特爾已經爲新近出貨和一些較老的處理器推出微碼更新\[42\]\[43\]，但是該措施通常需要主機板廠商的配合，以便將處理器廠商提供的微碼更新整合至其主機板的BIOS/EFI韌體上，因此會出現一些較老的、早已不享有保固服務的主機板沒有獲得微碼更新的情況；而部分較老的處理器，也是未能獲得微碼更新。\[44\]對於一些主機板廠商未有發佈帶微碼更新韌體，但處理器廠商已經推出微碼更新修復程式的，有的使用者會嘗試以自製主機板韌體的方式安裝微碼更新。\[45\]

英特爾在其新出貨的處理器上內建了對於阻擋利用該類缺陷進行攻擊的微碼更新，並在2018年下半年推出硬體層級上帶特權隔離措施和行程隔離的處理器產品；\[46\]\[47\]\[48\]\[49\]\[50\]ARM則是發佈了針對受影響處理器核心的韌體修復程式；\[51\]AMD儘管宣稱未受CVE-2017-5715的影響，但仍舊發佈了相應的微碼更新。\[52\]

### 其它

在Windows平臺上有第三方軟體可偵測電腦硬體受Spectre、Meltdown影響的程度和修補狀態。\[53\]\[54\]\[55\]

## 参考文献

## 外部链接

  - [Meltdown和Spectre漏洞的官方网站](https://meltdownattack.com/)
  - [Spectre论文](https://spectreattack.com/spectre.pdf)
  - [Google Project Zero write-up](https://googleprojectzero.blogspot.co.at/2018/01/reading-privileged-memory-with-side.html)
  - [网络安全实践指南—CPU熔断和幽灵漏洞防范指引](http://www.tc260.org.cn/upload/2018-01-16/1516081883218060656.pdf)

## 参见

  - [熔毁 (安全漏洞)](../Page/熔毁_\(安全漏洞\).md "wikilink") - 英特尔微处理器中的硬件漏洞，允许未经授权的进程访问特权内存。

  - \- 动态随机存取存储器中的意外副作用，导致存储单元之间发生电气相互作用。

{{-}}

[Category:電腦安全](https://zh.wikipedia.org/wiki/Category:電腦安全 "wikilink") [Category:硬件漏洞](https://zh.wikipedia.org/wiki/Category:硬件漏洞 "wikilink") [Category:旁路攻击](https://zh.wikipedia.org/wiki/Category:旁路攻击 "wikilink") [Category:X86架構](https://zh.wikipedia.org/wiki/Category:X86架構 "wikilink") [Category:X86内存管理](https://zh.wikipedia.org/wiki/Category:X86内存管理 "wikilink") [Category:程式錯誤](https://zh.wikipedia.org/wiki/Category:程式錯誤 "wikilink")

1.

2.

3.

4.

5.

6.

7.  [Mozilla Foundation Security Advisory 2018-01](https://www.mozilla.org/en-US/security/advisories/mfsa2018-01/)

8.  <https://www.theregister.co.uk/2018/01/04/intel_amd_arm_cpu_vulnerability/>, the Register, 2018-01-04.

9.

10.

11.

12.

13.
14.
15.

16.

17.

18.

19.

20.

21.

22.

23.
24.

25.
26. [安全漏洞作祟、微軟：更新會拖慢電腦](https://www.moneydj.com/KMDJ/News/NewsViewer.aspx?a=fb5e7bc2-42be-4465-9619-de0b8964b582)

27.

28.

29.

30.

31.
32.

33.
34.

35.

36.

37.

38.

39.

40.

41.

42.

43.

44.

45.

46.

47.

48.

49.

50.

51.

52.

53.

54.  ソフトアンテナブログ |url=<https://www.softantenna.com/wp/review/inspectre/> |website=www.softantenna.com |language=ja}}

55.
**排号自旋锁**是[计算机科学中的一种多线程](../Page/计算机科学.md "wikilink")[同步机制](../Page/同步_\(计算机科学\).md "wikilink")。类似于[自旋锁](../Page/自旋锁.md "wikilink")，但每一个申请排队自旋锁的线程获得一个排队号（ticket）。至多一个线程拥有自旋锁，当它释放锁时，把自身的ticket加1作为下一个可获得锁的ticket，持有该ticket的线程在自旋检查时就可发现已经获得了自旋锁。这种机制类似于一些提供社会服务的场所（如银行）：进门的顾客从排号机获取一个等待号，然后不断检查当前可服务的号，直至轮到其手持的号。
[Take_a_ticket.jpg](https://zh.wikipedia.org/wiki/File:Take_a_ticket.jpg "fig:Take_a_ticket.jpg")

这是一种先进先出(FIFO)的公平性机制。\[1\]\[2\]\[3\]

## 锁的比较

[Linux内核实现的排号自旋锁](../Page/Linux内核.md "wikilink")，比更简单的基于[test-and-set或](https://zh.wikipedia.org/wiki/test-and-set "wikilink")[exchange的自旋锁](https://zh.wikipedia.org/wiki/compare-and-swap "wikilink")，有更低时耗。下表比较了各种自旋锁：\[4\]

| 标准                    | [test-and-set](https://zh.wikipedia.org/wiki/test-and-set "wikilink") | [Test and Test-and-set](https://zh.wikipedia.org/wiki/Test_and_Test-and-set "wikilink") | [Load-link/store-conditional](https://zh.wikipedia.org/wiki/Load-link/store-conditional "wikilink") | Ticket | [ABQL](https://zh.wikipedia.org/wiki/Array_Based_Queuing_Locks "wikilink") |
| --------------------- | --------------------------------------------------------------------- | --------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- | ------ | -------------------------------------------------------------------------- |
| Uncontended latency   | Lowest                                                                | Lower                                                                                   | Lower                                                                                               | Higher | Higher                                                                     |
| 1 Release max traffic | Ө(p)                                                                  | Ө(p)                                                                                    | Ө(p)                                                                                                | Ө(p)   | Ө(1)                                                                       |
| Wait traffic          | High                                                                  | \-                                                                                      | \-                                                                                                  | \-     | \-                                                                         |
| Storage               | Ө(1)                                                                  | Ө(1)                                                                                    | Ө(1)                                                                                                | Ө(1)   | Ө(p)                                                                       |
| Fairness guarantee    | No                                                                    | No                                                                                      | No                                                                                                  | Yes    | Yes                                                                        |

Comparing Performance of Different Locking Mechanisms\[5\]

排号自旋锁的一个缺点是随着CPU核数增加，性能指数下降。\[6\]

## 历史

1991年Mellor-Crummey与Scott引入概念。\[7\]2008年被[Linux内核使用](../Page/Linux内核.md "wikilink")。\[8\]
\[9\]
2010年7月，解决了[半虚拟化问题](https://zh.wikipedia.org/wiki/半虚拟化 "wikilink")。\[10\]2015年3月，Red
Hat Enterprise Linux使用了这种锁。\[11\]

## 相关工作

  - [Lamport面包店算法](../Page/Lamport面包店算法.md "wikilink")
  - 基于队列的自旋锁<ref>

Michael L. Scott and William N. Scherer III. [*Scalable Queue-Based Spin
Locks with
Timeout*](http://ftp.cs.rochester.edu/u/scott/papers/2001_PPoPP_Timeout.pdf).
Proceedings of the eighth ACM SIGPLAN symposium on Principles and
practices of parallel programming, pp. 44-52, 2001.</ref>

## 参见

  - [fetch-and-add](https://zh.wikipedia.org/wiki/fetch-and-add "wikilink")
    用于排队自旋锁的原子操作

## 参考文献

[Category:并发控制](https://zh.wikipedia.org/wiki/Category:并发控制 "wikilink")

1.

2.
3.

4.

5.
6.  Boyd-Wickizer, Silas, et al. "Non-scalable locks are dangerous."
    Proceedings of the Linux Symposium. 2012.
    <http://pdos.csail.mit.edu/papers/linux:lock.pdf>

7.
8.  Jonathan Corbet, [Ticket
    spinlocks](https://lwn.net/Articles/267968/), Linux Weekly News,
    February 6, 2008. Retrieved 23. July, 2010.

9.  Jeremy Fitzhardinge, [paravirt: introduce a "lock-byte" spinlock
    implementation](https://git.kernel.org/?p=linux/kernel/git/torvalds/linux.git;a=commitdiff;h=8efcbab674de2bee45a2e4cdf97de16b8e609ac8),
    [Linux
    kernel](https://zh.wikipedia.org/wiki/Linux_kernel "wikilink"), July
    7, 2008

10. [Revert "Merge branch 'xen/pvticketlock' into
    xen/next"](https://git.kernel.org/?p=linux/kernel/git/jeremy/xen.git;a=commitdiff;h=3f3651d8620bd601f02b08a6bb57370057855417)

11.
**自旋锁**是[计算机科学用于多线程](../Page/计算机科学.md "wikilink")[同步的一种](../Page/同步_\(计算机科学\).md "wikilink")[锁](../Page/互斥锁.md "wikilink")，线程反复检查锁变量是否可用。由于线程在这一过程中保持执行，因此是一种[忙等待](https://zh.wikipedia.org/wiki/忙等待 "wikilink")。一旦获取了自旋锁，线程会一直保持该锁，直至显式释放自旋锁。

自旋锁避免了进程上下文的调度开销，因此对于线程只会阻塞很短时间的场合是有效的。因此操作系统的实现在很多地方往往用自旋锁。Windows操作系统提供的轻型[读写锁](../Page/读写锁.md "wikilink")（SRW
Lock）内部就用了自旋锁。显然，单核CPU不适于使用自旋锁，这里的单核CPU指的是单核单线程的CPU，因为，在同一时间只有一个线程是处在运行状态，假设运行线程A发现无法获取锁，只能等待解锁，但因为A自身不挂起，所以那个持有锁的线程B没有办法进入运行状态，只能等到操作系统分给A的时间片用完，才能有机会被调度。这种情况下使用自旋锁的代价很高。

获取、释放自旋锁，实际上是读写自旋锁的存储内存或寄存器。因此这种读写操作必须是[原子的](https://zh.wikipedia.org/wiki/原子操作 "wikilink")。通常用[test-and-set等原子操作来实现](https://zh.wikipedia.org/wiki/test-and-set "wikilink")。\[1\]

## Windows内核API

  - KeInitializeSpinLock //初始化自旋锁
  - KeAcquireSpinLock //获取自旋锁
  - KeReleaseSpinLock //释放自旋锁

## 例子

汇编语言写的代码，运行于[Intel](https://zh.wikipedia.org/wiki/Intel "wikilink")
[80386兼容处理器](https://zh.wikipedia.org/wiki/80386 "wikilink")。

``` nasm
; Intel syntax

locked:                      ; The lock variable. 1 = locked, 0 = unlocked.
     dd      0

spin_lock:
     mov     eax, 1          ; Set the EAX register to 1.

     xchg    eax, [locked]   ; Atomically swap the EAX register with
                             ;  the lock variable.
                             ; This will always store 1 to the lock, leaving
                             ;  the previous value in the EAX register.

     test    eax, eax        ; Test EAX with itself. Among other things, this will
                             ;  set the processor's Zero Flag if EAX is 0.
                             ; If EAX is 0, then the lock was unlocked and
                             ;  we just locked it.
                             ; Otherwise, EAX is 1 and we didn't acquire the lock.

     jnz     spin_lock       ; Jump back to the MOV instruction if the Zero Flag is
                             ;  not set; the lock was previously locked, and so
                             ; we need to spin until it becomes unlocked.

     ret                     ; The lock has been acquired, return to the calling
                             ;  function.

spin_unlock:
     mov     eax, 0          ; Set the EAX register to 0.

     xchg    eax, [locked]   ; Atomically swap the EAX register with
                             ;  the lock variable.

     ret                     ; The lock has been released.
```

## 参见

  - [Busy spin](https://zh.wikipedia.org/wiki/Busy_spin "wikilink")
  - [Deadlock](https://zh.wikipedia.org/wiki/Deadlock "wikilink")
  - [Seqlock](https://zh.wikipedia.org/wiki/Seqlock "wikilink")
  - [Ticket lock](https://zh.wikipedia.org/wiki/Ticket_lock "wikilink")

## 参考文献

<references/>

## 外部链接

  - [pthread_spin_lock
    documentation](http://www.opengroup.org/onlinepubs/009695399/functions/pthread_spin_lock.html)
    from The Open Group Base Specifications Issue 6, IEEE Std 1003.1,
    2004 Edition
  - [Variety of spinlock
    Implementations](https://github.com/concurrencykit/ck/blob/master/include/ck_spinlock.h)
    from Concurrency Kit
  - Article "[User-Level Spin Locks - Threads, Processes &
    IPC](https://web.archive.org/web/20041211235628/http://www.codeproject.com/threads/spinlocks.asp)"
    by [Gert
    Boddaert](https://zh.wikipedia.org/wiki/Gert_Boddaert "wikilink")
  - Paper "[The Performance of Spin Lock Alternatives for Shared-Memory
    Multiprocessors](http://www.cs.washington.edu/homes/tom/pubs/spinlock.html)"
    by [Thomas E.
    Anderson](https://zh.wikipedia.org/wiki/Thomas_E._Anderson "wikilink")
  - Paper "[Algorithms for Scalable Synchronization on Shared-Memory
    Multiprocessors](http://portal.acm.org/citation.cfm?id=103727.103729)"
    by [John M.
    Mellor-Crummey](https://zh.wikipedia.org/wiki/John_M._Mellor-Crummey "wikilink")
    and [Michael L.
    Scott](https://zh.wikipedia.org/wiki/Michael_L._Scott "wikilink").
    This paper received the [2006 Dijkstra Prize in Distributed
    Computing](http://www.podc.org/dijkstra/2006.html).
  - [Spin-Wait
    Lock](http://msdn.microsoft.com/en-us/magazine/cc163726.aspx) by
    [Jeffrey
    Richter](https://zh.wikipedia.org/wiki/Jeffrey_Richter "wikilink")
  - [Austria C++ SpinLock Class
    Reference](http://austria.sourceforge.net/dox/html/classSpinLock.html)
  - \[<http://msdn2.microsoft.com/en-us/library/ms684122(VS.85>).aspx
    Interlocked Variable Access(Windows)\]
  - [Operating Systems: Three Easy Pieces (Chapter:
    Locks)](http://pages.cs.wisc.edu/~remzi/OSTEP/threads-locks.pdf)

[Category:并发控制](https://zh.wikipedia.org/wiki/Category:并发控制 "wikilink")
[Category:编译原理](https://zh.wikipedia.org/wiki/Category:编译原理 "wikilink")

1.
**读写锁**是计算机程序的[并发控制](../Page/并发控制.md "wikilink")的一种同步机制，也称“共享-互斥锁”、多读者-单写者锁。\[1\]**多读者锁**，\[2\]，“push lock”\[3\]) 用于解决。读操作可并发重入，写操作是互斥的。

读写锁通常用[互斥锁](../Page/互斥锁.md "wikilink")、[条件变量](https://zh.wikipedia.org/wiki/条件变量 "wikilink")、[信号量](../Page/信号量.md "wikilink")实现。

某些读写锁允许在读模式与写模式之间升降级。[1](http://www.boost.org/doc/html/thread/synchronization.html#thread.synchronization.mutex_concepts.upgrade_lockable)

## 优先级策略

读写锁可以有不同的操作模式优先级：

  - 读操作优先：允许最大并发，但写操作可能饿死。
  - 写操作优先：一旦所有已经开始的读操作完成，等待的写操作立即获得锁。\[4\]内部实现需要两把互斥锁。\[5\]
  - 未指定优先级

## 实现

### 使用两把互斥锁

使用两把互斥锁与一个整数计数器实现。计数器跟踪被阻塞的读线程。互斥锁保护，供读者使用。互斥锁 (指"global")确保写操作互斥。伪代码：

<div style="margin-left: 35px; width: 600px">

**Begin Read**

  - Lock .
  - Increment .
  - If  1}}, lock .
  - Unlock .

</div>

<div style="margin-left: 35px; width: 600px">

**End Read**

  - Lock .
  - Decrement .
  - If  0}}, unlock .
  - Unlock .

</div>

<div style="margin-left: 35px; width: 600px">

**Begin Write**

  - Lock .

</div>

<div style="margin-left: 35px; width: 600px">

**End Write**

  - Unlock .

</div>

实现是读操作优先。\[6\]

### 使用条件变量与互斥锁

可使用[条件变量](https://zh.wikipedia.org/wiki/条件变量 "wikilink")与普通的互斥锁、整型计数器（表示正在读的个数）与布尔标志（表示正在写）来实现读写锁。

lock-for-read操作：\[7\]\[8\]\[9\]

<div style="margin-left: 35px; width: 600px">

  - Lock  (blocking).
  - While :
      -
  - Increment .
  - Unlock .

</div>

lock-for-write操作：

<div style="margin-left: 35px; width: 600px">

  - Lock  (blocking).
  - While ( or ):
      -
  - Set  to .
  - Unlock .

</div>

lock-for-read与lock-for-write各自有自己的逆操作。unlock-for-read通过减量并在变为0时通知。unlock-for-write设置为false并通知。

## 程序语言支持

  - [POSIX标准的](https://zh.wikipedia.org/wiki/POSIX "wikilink")`pthread_rwlock_t`与相关操作<ref>

</ref>

  - ReadWriteLock\[10\] 接口，ReentrantReadWriteLock\[11\]锁，从[Java版本](https://zh.wikipedia.org/wiki/Java_\(programming_language\) "wikilink")5开始
  - Microsoft `System.Threading.ReaderWriterLockSlim`锁，用于[C\#与](https://zh.wikipedia.org/wiki/C# "wikilink")[.NET语言程序](https://zh.wikipedia.org/wiki/.NET_Framework "wikilink")<ref>

</ref>

  - `std::shared_mutex` read/write锁在[C++17](../Page/C++17.md "wikilink")<ref>

</ref>

  - `boost::shared_mutex`与`boost::upgrade_mutex`锁在[Boost C++ Libraries](../Page/Boost_C++_Libraries.md "wikilink")<ref>

</ref>

  - `sync.RWMutex`在[Go语言](https://zh.wikipedia.org/wiki/Go语言 "wikilink")<ref>

</ref>

  - Phase fair reader–writer lock\[12\]
  - `std::sync::RwLock`，在[Rust](../Page/Rust.md "wikilink")语言<ref>

</ref>

  - Poco::RWLock，在
  - `mse::recursive_shared_timed_mutex`在\[//github.com/duneroadrunner/SaferCPlusPlus SaferCPlusPlus\]库，是支持[`std::recursive_mutex`](http://en.cppreference.com/w/cpp/thread/recursive_mutex)的recursive ownership语义的[`std::shared_timed_mutex`](http://en.cppreference.com/w/cpp/thread/shared_timed_mutex)的一个实现
  - `txrwlock.ReadersWriterDeferredLock`，用于[Twisted](https://zh.wikipedia.org/wiki/Twisted "wikilink")<ref>

</ref>

### Windows操作系统

`SRWLock`，见[Windows操作系统API](https://zh.wikipedia.org/wiki/Microsoft_Windows "wikilink")，从[Windows Vista开始](../Page/Windows_Vista.md "wikilink").\[13\]

读写锁（Slim reader/writer，SRW， lock）用于进程内的线程间同步。 SRW既不是公平的也不是先进先出的。读写锁数据结构的内部实现就是一个指针。读写锁的性能较[临界区有很大的提升](https://zh.wikipedia.org/wiki/临界区 "wikilink")，这是因为读写锁是基于原子操作，关键段是基于event内核对象的，从用户模式到内核模式的切换占用了大量的时钟周期。相关API：\[14\]

  - InitializeSRWLock：动态初始化SRW结构。也可以直接赋值SRWLOCK_INIT常量来静态初始化SRW结构。不需要显式析构。
  - AcquireSRWLockShared：获取共享读的SRW锁。
  - AcquireSRWLockExclusive：获取专享写的SRW锁。
  - TryAcquireSRWLockShared：试图获取共享读的SRW锁。
  - TryAcquireSRWLockExclusive：试图获取专享写的SRW锁。
  - ReleaseSRWLockShared：释放已经获取的共享读的SRW锁。
  - ReleaseSRWLockExclusive：释放已经获取的专享写的SRW锁。
  - SleepConditionVariableSRW：在已经获取SRW锁的前提下，原子操作：在指定[条件变量上睡眠并释放SRW锁](https://zh.wikipedia.org/wiki/条件变量 "wikilink")

## 可选

[read-copy-update](https://zh.wikipedia.org/wiki/read-copy-update "wikilink") (RCU)算法是读写锁的一种替代实现。RCU对读操作是无等待。[Linux内核](../Page/Linux内核.md "wikilink")实现了很少写操作的一种RCU叫做[seqlock](https://zh.wikipedia.org/wiki/seqlock "wikilink")。

## 参见

  - [信号量](../Page/信号量.md "wikilink")

  - [互斥锁](../Page/互斥锁.md "wikilink")

  - [调度_(计算机)](../Page/调度_\(计算机\).md "wikilink")

  -
  - [文件锁定](../Page/文件锁定.md "wikilink")

  - [锁_(计算机科学)](https://zh.wikipedia.org/wiki/锁_\(计算机科学\) "wikilink")

## 注释

## 参考文献

[Category:并发控制](https://zh.wikipedia.org/wiki/Category:并发控制 "wikilink")

1.

2.  ["Practical lock-freedom"](http://www.cl.cam.ac.uk/TechReports/UCAM-CL-TR-579.pdf) by Keir Fraser 2004

3.

4.

5.   Java readers–writer lock implementation offers a "fair" mode

6.

7.

8.

9.

10.

11.
12.

13.

14. \[<https://msdn.microsoft.com/en-us/library/aa904937(VS.85>).aspx MSDN: Slim Reader/Writer (SRW) Locks\]